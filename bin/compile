#!/usr/bin/env bash
####
#
# Used to perform the transformation steps on the app
#
# Usage:
#
# ```shell
# bin/compile BUILD_DIR CACHE_DIR ENV_DIR
# ```
#
# ToDo:
#   - update for modules
#   - enable python support for addons
#   - cache the compiled source
#   - possible to configure if no znc.conf found?
#
set -e
set -o pipefail

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

VERSION=1.6.0
RELEASE="znc-$VERSION"

indent() {
    sed -u 's/^/       /'
}

echo "-----> BUILD_DIR"
echo "$BUILD_DIR" | indent
echo "-----> CACHE_DIR"
echo "$CACHE_DIR" | indent
echo "-----> ENV_DIR"
echo "$ENV_DIR" | indent

echo -n $VERSION > $BUILD_DIR/VERSION
cat $BUILD_DIR/VERSION

exit 1

echo "-----> Downloading"
cd $BUILD_DIR
curl -s "http://znc.in/releases/$RELEASE.tar.gz" > znc.tar.gz
tar -xzf znc.tar.gz
mv $RELEASE src
rm znc.tar.gz

echo "-----> Configuring"
cd $BUILD_DIR/src/
./autogen.sh 2>&1 1>/dev/null | indent
./configure --prefix=$BUILD_DIR --enable-run-from-source | indent

echo "-----> Compiling"
make 2>&1 1>/dev/null | indent

echo "-----> Installing"
make install 2>&1 1>/dev/null | indent
mkdir -vp $BUILD_DIR/.znc/{configs,modules,moddata,users}
mv -v $BUILD_DIR/znc.conf $BUILD_DIR/.znc/configs/znc.conf
ls -alh $BUILD_DIR
ls -alh $BUILD_DIR/bin/

exit 0
